<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Calendar Summarizer</title>
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#9aa4b2;
      --accent:#7c5cff;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg, #071021 0%, #0f1724 60%);color:#e6eef8}
    .container{max-width:920px;margin:48px auto;padding:20px}
    .header{margin-bottom:18px}
    .header h1{margin:0;font-size:28px;letter-spacing:-0.5px}
    .tagline{margin:6px 0 0;color:var(--muted)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:20px;box-shadow:0 6px 20px rgba(2,6,23,0.7);border:1px solid rgba(255,255,255,0.03);margin-bottom:20px}
    .tabs{display:flex;gap:8px;margin-bottom:20px;border-bottom:1px solid rgba(255,255,255,0.05);padding-bottom:8px}
    .tab{padding:8px 16px;border-radius:6px 6px 0 0;background:transparent;border:none;color:var(--muted);cursor:pointer;transition:all 0.2s}
    .tab.active{background:var(--glass);color:#fff;border-bottom:2px solid var(--accent)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .form{display:flex;flex-direction:column;gap:12px}
    .field{display:flex;flex-direction:column}
    .label{font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=file],input[type=text],input[type=datetime-local]{padding:8px;background:var(--glass);border-radius:8px;border:1px solid rgba(255,255,255,0.08);color:inherit}
    input[type=file]{border:1px dashed rgba(255,255,255,0.03)}
    textarea{resize:vertical;min-height:80px;padding:10px;border-radius:8px;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.08);color:inherit}
    .actions{display:flex;gap:8px;margin-top:6px}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;cursor:pointer;transition:all 0.2s}
    .btn.primary{background:linear-gradient(90deg,var(--accent), #5b9bff);color:#fff;border:none}
    .btn:hover:not(:disabled){opacity:0.9;transform:translateY(-1px)}
    .btn:disabled{opacity:0.6;cursor:not-allowed}
    .status{margin-top:12px;color:var(--muted);font-size:13px}
    .status.error{color:#ffb4b4}
    .result{margin-top:14px;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
    .result h2{margin:0 0 8px 0;font-size:16px}
    .result pre{white-space:pre-wrap;word-break:break-word;margin:0;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;font-size:13px;color:#dbeafe}
    .calendar-grid{display:grid;grid-template-columns:repeat(7, 1fr);gap:1px;background:rgba(255,255,255,0.05);border-radius:8px;overflow:hidden;margin-top:12px}
    .calendar-header{background:rgba(124,92,255,0.1);padding:12px 8px;text-align:center;font-size:13px;font-weight:500;color:var(--accent)}
    .calendar-day{background:rgba(0,0,0,0.2);padding:8px;min-height:80px;cursor:pointer;transition:all 0.2s;position:relative}
    .calendar-day:hover{background:rgba(255,255,255,0.05)}
    .calendar-day.other-month{opacity:0.4}
    .day-number{font-size:14px;margin-bottom:4px;color:var(--muted)}
    .day-number.today{color:var(--accent);font-weight:600}
    .event-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);margin:2px auto;display:block}
    .events-list{margin-top:12px}
    .event-item{background:rgba(124,92,255,0.1);border-left:3px solid var(--accent);padding:10px;border-radius:6px;margin-bottom:8px;cursor:pointer;transition:all 0.2s}
    .event-item:hover{background:rgba(124,92,255,0.15);transform:translateX(2px)}
    .event-title{font-weight:500;margin-bottom:4px}
    .event-time{font-size:12px;color:var(--muted)}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:1000;align-items:center;justify-content:center}
    .modal.active{display:flex}
    .modal-content{background:linear-gradient(180deg, rgba(15,23,36,0.98), rgba(11,18,32,0.98));border-radius:12px;padding:24px;max-width:500px;width:90%;border:1px solid rgba(255,255,255,0.1);box-shadow:0 20px 40px rgba(0,0,0,0.5)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .modal-title{font-size:20px;margin:0}
    .close-btn{background:transparent;border:none;color:var(--muted);font-size:24px;cursor:pointer;padding:0;width:32px;height:32px}
    .close-btn:hover{color:#fff}
    .calendar-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .calendar-nav h3{margin:0;font-size:18px}
    .nav-btns{display:flex;gap:8px}
    .footer{margin-top:18px;color:var(--muted);font-size:13px}
    @media (max-width:640px){.container{margin:20px;padding:14px}.header h1{font-size:20px}.calendar-grid{font-size:11px}.calendar-day{min-height:60px;padding:4px}}
  </style>
</head>
<body>
  <main class="container">
    <header class="header">
      <h1>Calendar Summarizer</h1>
      <p class="tagline">Create events in your calendar or upload an ICS file to generate summaries.</p>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="calendar">My Calendar</button>
      <button class="tab" data-tab="upload">Upload ICS</button>
    </div>

    <div id="calendarTab" class="tab-content active">
      <section class="card">
        <div class="calendar-nav">
          <h3 id="currentMonth"></h3>
          <div class="nav-btns">
            <button class="btn" id="prevMonth">‹</button>
            <button class="btn" id="todayBtn">Today</button>
            <button class="btn" id="nextMonth">›</button>
          </div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
      </section>

      <section class="card">
        <h2 style="margin:0 0 12px 0;font-size:18px">Your Events</h2>
        <div class="actions">
          <button class="btn primary" id="addEventBtn">+ Add Event</button>
          <button class="btn" id="summarizeBtn">Generate Summary</button>
        </div>
        <div id="eventsList" class="events-list"></div>
      </section>
    </div>

    <div id="uploadTab" class="tab-content">
      <section class="card">
        <form id="generateForm" class="form" autocomplete="off">
          <label class="field">
            <span class="label">ICS file</span>
            <input id="icsFile" name="icsFile" type="file" accept=".ics">
          </label>

          <label class="field">
            <span class="label">Prompt (optional)</span>
            <textarea id="prompt" name="prompt" rows="4" placeholder="Summarize my upcoming week..."></textarea>
          </label>

          <div class="actions">
            <button id="submitBtn" type="submit" class="btn primary">Generate</button>
            <button id="clearBtn" type="button" class="btn">Clear</button>
          </div>
        </form>

        <div id="status" class="status" aria-live="polite"></div>

        <div id="result" class="result" hidden>
          <h2>Result</h2>
          <pre id="resultText"></pre>
        </div>
      </section>
    </div>

    <div id="summaryResult" class="card" style="display:none">
      <h2 style="margin:0 0 12px 0;font-size:18px">Calendar Summary</h2>
      <pre id="summaryText" style="white-space:pre-wrap;font-family:ui-monospace,monospace;font-size:13px;color:#dbeafe"></pre>
    </div>

    <footer class="footer">
      <small>Tip: Events are stored in your browser. Click "Add Event" to create calendar entries and "Generate Summary" to analyze them.</small>
    </footer>
  </main>

  <div id="eventModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Add Event</h2>
        <button class="close-btn" id="closeModal">×</button>
      </div>
      <form id="eventForm" class="form">
        <label class="field">
          <span class="label">Event Title</span>
          <input type="text" id="eventTitle" required>
        </label>
        <label class="field">
          <span class="label">Start Date & Time</span>
          <input type="datetime-local" id="eventStart" required>
        </label>
        <label class="field">
          <span class="label">End Date & Time</span>
          <input type="datetime-local" id="eventEnd" required>
        </label>
        <label class="field">
          <span class="label">Description (optional)</span>
          <textarea id="eventDesc" rows="3"></textarea>
        </label>
        <div class="actions">
          <button type="submit" class="btn primary">Save Event</button>
          <button type="button" class="btn" id="deleteEventBtn" style="display:none">Delete</button>
          <button type="button" class="btn" id="cancelEventBtn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const ENDPOINT = '/generate';
    
    let events = [];
    let currentDate = new Date();
    let editingEventId = null;

    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
      });
    });

    // Calendar navigation
    document.getElementById('prevMonth').addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    });

    document.getElementById('todayBtn').addEventListener('click', () => {
      currentDate = new Date();
      renderCalendar();
    });

    // Modal controls
    const modal = document.getElementById('eventModal');
    const eventForm = document.getElementById('eventForm');

    document.getElementById('addEventBtn').addEventListener('click', () => {
      editingEventId = null;
      document.getElementById('modalTitle').textContent = 'Add Event';
      document.getElementById('deleteEventBtn').style.display = 'none';
      eventForm.reset();
      modal.classList.add('active');
    });

    document.getElementById('closeModal').addEventListener('click', () => {
      modal.classList.remove('active');
    });

    document.getElementById('cancelEventBtn').addEventListener('click', () => {
      modal.classList.remove('active');
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.classList.remove('active');
    });

    // Event form submission
    eventForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const event = {
        id: editingEventId || Date.now().toString(),
        title: document.getElementById('eventTitle').value,
        start: new Date(document.getElementById('eventStart').value),
        end: new Date(document.getElementById('eventEnd').value),
        description: document.getElementById('eventDesc').value
      };

      if (editingEventId) {
        const index = events.findIndex(e => e.id === editingEventId);
        events[index] = event;
      } else {
        events.push(event);
      }

      events.sort((a, b) => a.start - b.start);
      renderCalendar();
      renderEventsList();
      modal.classList.remove('active');
    });

    document.getElementById('deleteEventBtn').addEventListener('click', () => {
      if (editingEventId && confirm('Delete this event?')) {
        events = events.filter(e => e.id !== editingEventId);
        renderCalendar();
        renderEventsList();
        modal.classList.remove('active');
      }
    });

    // Render calendar
    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const prevDaysInMonth = new Date(year, month, 0).getDate();
      
      document.getElementById('currentMonth').textContent = `${months[month]} ${year}`;
      
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = days.map(d => `<div class="calendar-header">${d}</div>`).join('');

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Previous month days
      for (let i = firstDay - 1; i >= 0; i--) {
        const day = prevDaysInMonth - i;
        grid.innerHTML += `<div class="calendar-day other-month"><div class="day-number">${day}</div></div>`;
      }

      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        date.setHours(0, 0, 0, 0);
        const isToday = date.getTime() === today.getTime();
        const dayEvents = events.filter(e => {
          const eventDate = new Date(e.start);
          eventDate.setHours(0, 0, 0, 0);
          return eventDate.getTime() === date.getTime();
        });
        
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.innerHTML = `<div class="day-number ${isToday ? 'today' : ''}">${day}</div>`;
        if (dayEvents.length > 0) {
          dayEvents.forEach(() => dayEl.innerHTML += '<span class="event-dot"></span>');
        }
        dayEl.addEventListener('click', () => openDayEvents(date));
        grid.appendChild(dayEl);
      }

      // Next month days
      const totalCells = grid.children.length - 7;
      const remainingCells = 42 - totalCells;
      for (let day = 1; day <= remainingCells; day++) {
        grid.innerHTML += `<div class="calendar-day other-month"><div class="day-number">${day}</div></div>`;
      }
    }

    function openDayEvents(date) {
      const dayEvents = events.filter(e => {
        const eventDate = new Date(e.start);
        eventDate.setHours(0, 0, 0, 0);
        date.setHours(0, 0, 0, 0);
        return eventDate.getTime() === date.getTime();
      });

      if (dayEvents.length === 0) {
        const datetime = date.toISOString().slice(0, 16);
        document.getElementById('eventStart').value = datetime;
        document.getElementById('eventEnd').value = datetime;
        document.getElementById('addEventBtn').click();
      }
    }

    function renderEventsList() {
      const list = document.getElementById('eventsList');
      if (events.length === 0) {
        list.innerHTML = '<p style="color:var(--muted);font-size:13px;margin-top:12px">No events yet. Click "Add Event" to get started.</p>';
        return;
      }

      list.innerHTML = events.map(e => `
        <div class="event-item" data-id="${e.id}">
          <div class="event-title">${e.title}</div>
          <div class="event-time">${formatDateTime(e.start)} - ${formatDateTime(e.end)}</div>
        </div>
      `).join('');

      list.querySelectorAll('.event-item').forEach(item => {
        item.addEventListener('click', () => {
          const event = events.find(e => e.id === item.dataset.id);
          editEvent(event);
        });
      });
    }

    function editEvent(event) {
      editingEventId = event.id;
      document.getElementById('modalTitle').textContent = 'Edit Event';
      document.getElementById('deleteEventBtn').style.display = 'block';
      document.getElementById('eventTitle').value = event.title;
      document.getElementById('eventStart').value = event.start.toISOString().slice(0, 16);
      document.getElementById('eventEnd').value = event.end.toISOString().slice(0, 16);
      document.getElementById('eventDesc').value = event.description || '';
      modal.classList.add('active');
    }

    function formatDateTime(date) {
      return date.toLocaleString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
      });
    }

    // Summary generation
    document.getElementById('summarizeBtn').addEventListener('click', async () => {
      if (events.length === 0) {
        alert('No events to summarize. Add some events first!');
        return;
      }

      const summaryDiv = document.getElementById('summaryResult');
      const summaryText = document.getElementById('summaryText');
      summaryDiv.style.display = 'block';
      summaryText.textContent = 'Generating summary...';

      const eventsText = events.map(e => 
        `${e.title}\nStart: ${e.start.toLocaleString()}\nEnd: ${e.end.toLocaleString()}\n${e.description ? 'Description: ' + e.description : ''}`
      ).join('\n\n');

      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1000,
            messages: [{
              role: 'user',
              content: `Analyze this calendar and provide a helpful summary:\n\n${eventsText}\n\nProvide a brief overview of the schedule, highlighting key events, busy periods, and any patterns you notice.`
            }]
          })
        });

        const data = await response.json();
        const text = data.content.map(c => c.type === 'text' ? c.text : '').join('\n');
        summaryText.textContent = text;
      } catch (err) {
        summaryText.textContent = 'Error generating summary: ' + err.message;
      }
    });

    // Upload form (existing functionality)
    const form = document.getElementById('generateForm');
    const icsFileEl = document.getElementById('icsFile');
    const promptEl = document.getElementById('prompt');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const resultText = document.getElementById('resultText');

    function setStatus(text, isError = false) {
      statusEl.textContent = text;
      statusEl.classList.toggle('error', isError);
    }

    clearBtn.addEventListener('click', () => {
      promptEl.value = '';
      icsFileEl.value = '';
      resultEl.hidden = true;
      resultText.textContent = '';
      setStatus('Cleared.');
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      resultEl.hidden = true;
      resultText.textContent = '';

      const formData = new FormData();
      const file = icsFileEl.files[0];
      const prompt = promptEl.value.trim();

      if (file) formData.append('icsFile', file);
      if (prompt) formData.append('prompt', prompt);

      if (!file && !prompt) {
        setStatus('Please provide an .ics file or a prompt.', true);
        return;
      }

      submitBtn.disabled = true;
      setStatus('Sending request...');

      try {
        const resp = await fetch(ENDPOINT, {
          method: 'POST',
          body: formData
        });

        if (!resp.ok) {
          const text = await resp.text().catch(() => resp.statusText);
          throw new Error(text || `Server returned ${resp.status}`);
        }

        let bodyText;
        try {
          bodyText = await resp.text();
        } catch (err) {
          const json = await resp.json();
          bodyText = JSON.stringify(json, null, 2);
        }

        resultText.textContent = bodyText;
        resultEl.hidden = false;
        setStatus('Done.');
      } catch (err) {
        console.error(err);
        setStatus('Request failed: ' + (err.message || err), true);
      } finally {
        submitBtn.disabled = false;
      }
    });

    // Initialize
    renderCalendar();
    renderEventsList();
  </script>
</body>
</html>